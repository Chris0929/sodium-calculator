<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CKD Nutrient Analyzer - Safer Version</title>
<style>
  body { font-family: Arial, sans-serif; background: #fef6f0; padding: 20px; color: #333; }
  h1 { color: #6c5b7b; }
  textarea { width: 100%; height: 100px; font-size: 16px; padding: 10px; margin-bottom: 20px; background: #fff0f5; }
  button { padding: 10px 20px; font-size: 16px; background: #ffb6b9; color: white; border: none; border-radius: 5px; cursor: pointer; }
  .nutrients { margin-top: 20px; background: #f6eec7; padding: 15px; border-radius: 5px; }
  .alerts { color: red; font-weight: bold; }
  pre { background: #fff; padding: 10px; border-radius: 5px; overflow-x: auto; }
  .disclaimer { margin-top: 30px; font-size: 0.9em; color: #b33; }
</style>
</head>
<body>

<h1>CKD Nutrient Analyzer - Safer Version</h1>

<p>Please consult a healthcare professional before making dietary decisions based on this tool.</p>

<textarea id="foodInput" placeholder="Enter food with quantity (e.g. '2 tbsp peanut butter')"></textarea>
<button onclick="analyzeFood()">Analyze</button>

<div class="nutrients" id="results"></div>

<script>
const apiKey = "TP6duc7H0lDuNEKyPrpR49mtr5dJqTNwYw8vjgKZ";

// Basic unit to grams conversion for common cooking units (approximate, water density assumptions)
const unitToGrams = {
  g: 1,
  gram: 1,
  grams: 1,
  tsp: 4.2,     // approx weight in grams for water-like density
  tbsp: 14.3,
  cup: 240,
  oz: 28.35,
  ml: 1,       // assuming density like water
};

function parseInput(input) {
  // Extract quantity, unit, and food description
  const regex = /^([\d.]+)\s*(\w+)\s+(.*)$/;
  const match = input.trim().toLowerCase().match(regex);
  if (!match) return null;
  return {
    quantity: parseFloat(match[1]),
    unit: match[2],
    food: match[3],
  };
}

async function analyzeFood() {
  const inputStr = document.getElementById("foodInput").value;
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "Analyzing...";

  const parsed = parseInput(inputStr);
  if (!parsed) {
    resultsDiv.innerHTML = "<span class='alerts'>❌ Please enter quantity, unit, and food name, e.g. '2 tbsp peanut butter'</span>";
    return;
  }

  if (!unitToGrams.hasOwnProperty(parsed.unit)) {
    resultsDiv.innerHTML = `<span class='alerts'>❌ Unit "${parsed.unit}" not supported. Use g, tsp, tbsp, cup, oz, or ml.</span>`;
    return;
  }

  try {
    // Search food in USDA API
    const searchResponse = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(parsed.food)}&pageSize=1&api_key=${apiKey}`);
    const searchData = await searchResponse.json();

    if (!searchData.foods || searchData.foods.length === 0) {
      resultsDiv.innerHTML = `<span class='alerts'>❌ Food not found in USDA database.</span>`;
      return;
    }

    const food = searchData.foods[0];

    // Fetch food details
    const detailResponse = await fetch(`https://api.nal.usda.gov/fdc/v1/food/${food.fdcId}?api_key=${apiKey}`);
    const detailData = await detailResponse.json();

    // Calculate grams from input quantity * unit conversion
    const gramsFromUser = parsed.quantity * unitToGrams[parsed.unit];

    // Check if USDA foodPortions includes matching unit to improve accuracy
    // Try to find USDA portion that matches unit for better gramWeight (e.g. 1 tbsp = 14.3g)
    let matchedPortionGramWeight = null;
    if (detailData.foodPortions && detailData.foodPortions.length > 0) {
      for (const portion of detailData.foodPortions) {
        const unitName = (portion.measureUnit && portion.measureUnit.name) ? portion.measureUnit.name.toLowerCase() : "";
        const modifier = portion.modifier ? portion.modifier.toLowerCase() : "";
        if (unitName.includes(parsed.unit) || modifier.includes(parsed.unit)) {
          matchedPortionGramWeight = portion.gramWeight;
          break;
        }
      }
    }

    // Use USDA portion weight if matched, else fallback to user gramsFromUser
    const gramsToUse = matchedPortionGramWeight ? matchedPortionGramWeight * parsed.quantity : gramsFromUser;

    // Nutrient mapping (some nutrients might have different names; map accordingly)
    const nutrientMap = {
      "Sodium, Na": "Sodium",
      "Potassium, K": "Potassium",
      "Protein": "Protein",
      "Phosphorus, P": "Phosphorus"
    };

    // Initialize nutrient sums
    let nutrients = {
      Sodium: 0,
      Potassium: 0,
      Protein: 0,
      Phosphorus: 0,
    };

    // Aggregate nutrient amounts scaled to gramsToUse (nutrient.amount is per 100g)
    detailData.foodNutrients.forEach(nutr => {
      for (const [apiName, key] of Object.entries(nutrientMap)) {
        if (nutr.nutrient.name === apiName) {
          nutrients[key] += (nutr.amount / 100) * gramsToUse;
        }
      }
    });

    // Round to 2 decimals
    for (const key in nutrients) {
      nutrients[key] = Math.round(nutrients[key] * 100) / 100;
    }

    // Build alerts based on CKD stage 3 limits
    let alertMsgs = [];
    if (nutrients.Sodium > 2000) alertMsgs.push("⚠️ High Sodium (>2000 mg)");
    if (nutrients.Protein > 51) alertMsgs.push("⚠️ High Protein (>51 g)");
    if (nutrients.Potassium > 4000) alertMsgs.push("⚠️ High Potassium (>4000 mg)");
    if (nutrients.Phosphorus > 1000) alertMsgs.push("⚠️ High Phosphorus (>1000 mg)");

    resultsDiv.innerHTML = `
      <h3>Results for "${parsed.quantity} ${parsed.unit} ${parsed.food}"</h3>
      <pre>
Sodium: ${nutrients.Sodium} mg
Potassium: ${nutrients.Potassium} mg
Protein: ${nutrients.Protein} g
Phosphorus: ${nutrients.Phosphorus} mg
      </pre>
      <div class="alerts">${alertMsgs.join("<br>")}</div>
    `;

  } catch (err) {
    console.error(err);
    resultsDiv.innerHTML = `<span class='alerts'>❌ Error fetching or processing data. Please try again.</span>`;
  }
}
</script>

</body>
</html>
