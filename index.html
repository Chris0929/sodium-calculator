<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nutrient Calculator with Accurate Unit Conversions</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 700px; margin: 20px auto; }
  textarea { width: 100%; height: 150px; }
  button { margin-top: 10px; padding: 10px 20px; font-size: 1rem; }
  .error { color: red; }
  .result { margin-top: 20px; padding: 10px; border: 1px solid #ddd; background: #f9f9f9; }
</style>
</head>
<body>

<h1>Nutrient Calculator</h1>

<textarea id="ingredientsInput" placeholder="Enter ingredients, e.g. '1/2 tsp salt'"></textarea>
<br />
<button id="calculateBtn">Calculate Nutrients</button>

<div id="results"></div>

<script>
// Your generic unit to grams conversion (can be adjusted)
const unitToGrams = {
  tsp: 5,
  tbsp: 15,
  cup: 240,
  oz: 28.35,
  lb: 453.6,
  g: 1,
  kg: 1000,
  ml: 1,
  l: 1000,
  // Add more generic units as needed
};

// Special overrides for ingredient + unit to grams conversion
const specialUnitWeights = {
  'salt|tsp': 6,
  'baking powder|tsp': 4.6,
  'baking soda|tsp': 4.8,
  'honey|tbsp': 21,
  'olive oil|tbsp': 13.5,
  'all-purpose flour|cup': 125,
  'granulated sugar|cup': 200,
  'butter|tbsp': 14,
  // Add more overrides as needed
};

// Function to parse ingredient line, simplistic version for demo
function parseIngredientLine(line) {
  // Regex to parse quantity, unit, and ingredient name
  // Example line: "1/2 tsp salt"
  const regex = /^\s*([\d\/\.]+)\s*([a-zA-Z]+)?\s*(.*)$/;
  const match = line.match(regex);
  if (!match) return null;

  let quantity = match[1];
  const unit = match[2] ? match[2].toLowerCase() : '';
  const ingredient = match[3].toLowerCase().trim();

  // Convert quantity from fraction if needed
  if (quantity.includes('/')) {
    const parts = quantity.split('/');
    if (parts.length === 2) {
      quantity = parseFloat(parts[0]) / parseFloat(parts[1]);
    } else {
      quantity = parseFloat(quantity);
    }
  } else {
    quantity = parseFloat(quantity);
  }

  if (isNaN(quantity)) return null;

  return { quantity, unit, ingredient };
}

// Simulated async fetch for demo - replace with real API call
async function fetchFoodData(ingredient) {
  // Simulated nutrient data per 100g for a few ingredients (mock)
  const db = {
    salt: { sodium_mg: 38758, calories: 0, protein_g: 0, fat_g: 0, carbs_g: 0 },
    'all-purpose flour': { calories: 364, protein_g: 10, fat_g: 1, carbs_g: 76 },
    honey: { calories: 304, protein_g: 0.3, fat_g: 0, carbs_g: 82 },
    'olive oil': { calories: 884, protein_g: 0, fat_g: 100, carbs_g: 0 },
    'granulated sugar': { calories: 387, protein_g: 0, fat_g: 0, carbs_g: 100 },
    butter: { calories: 717, protein_g: 0.85, fat_g: 81, carbs_g: 0.06 },
  };
  return db[ingredient] || null;
}

document.getElementById('calculateBtn').addEventListener('click', async () => {
  const input = document.getElementById('ingredientsInput').value.trim();
  const lines = input.split('\n').filter(line => line.trim() !== '');
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';

  for (const line of lines) {
    const parsed = parseIngredientLine(line);
    if (!parsed || !parsed.ingredient) {
      resultsDiv.innerHTML += `<p class="error">Could not parse ingredient line: "${line}"</p>`;
      continue;
    }

    const food = await fetchFoodData(parsed.ingredient);
    if (!food) {
      resultsDiv.innerHTML += `<p class="error">No nutrient data found for: "${parsed.ingredient}"</p>`;
      continue;
    }

    let grams = parsed.quantity;

    // Compose key for special overrides
    const key = parsed.ingredient + '|' + parsed.unit;

    if (parsed.unit && specialUnitWeights[key]) {
      grams *= specialUnitWeights[key];
    } else if (parsed.unit && unitToGrams[parsed.unit]) {
      grams *= unitToGrams[parsed.unit];
    }
    // else grams = quantity assumed grams if no unit

    const factor = grams / 100;

    // Calculate nutrients based on grams
    const calories = (food.calories || 0) * factor;
    const protein = (food.protein_g || 0) * factor;
    const fat = (food.fat_g || 0) * factor;
    const carbs = (food.carbs_g || 0) * factor;
    const sodium = (food.sodium_mg || 0) * factor;

    resultsDiv.innerHTML += `
      <div class="result">
        <strong>${line}</strong> (~${grams.toFixed(2)} g)<br />
        Calories: ${calories.toFixed(1)} kcal<br />
        Protein: ${protein.toFixed(1)} g<br />
        Fat: ${fat.toFixed(1)} g<br />
        Carbs: ${carbs.toFixed(1)} g<br />
        Sodium: ${sodium.toFixed(1)} mg
      </div>
    `;
  }
});
</script>

</body>
</html>
