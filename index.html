<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CKD Nutrient Analyzer</title>
  <style>
    body {
      background-color: #fef6f0;
      font-family: Arial, sans-serif;
      color: #333;
      padding: 20px;
    }
    h1 { color: #4e766d; }
    textarea {
      width: 100%;
      height: 100px;
      padding: 10px;
      font-size: 1em;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      background-color: #a8d5ba;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
    }
    button:hover {
      background-color: #91c3a2;
    }
    .result, .recommendation {
      margin-top: 20px;
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .alert {
      color: #b33636;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>CKD Nutrient Analyzer</h1>

  <div class="recommendation">
    <p><strong>Sodium:</strong> ~2,000mg/day. Always consult a doctor or registered dietitian.</p>
    <p><strong>Protein:</strong> 47–51g/day for those without diabetes, based on KDOQI guidelines.</p>
    <p><strong>Calories:</strong> 2116–2962/day depending on activity and body size.</p>
    <p><strong>Potassium:</strong> 2–4g/day (51–102 mmol/day) as per National Kidney Foundation.</p>
    <p><strong>Phosphorus:</strong> 800–1,000mg/day to avoid blood buildup.</p>
  </div>

  <textarea id="foodInput" placeholder="e.g., 2 tbsp peanut butter, 150g chicken breast..."></textarea>
  <button onclick="analyzeFood()">Analyze</button>

  <div class="result" id="results"></div>

  <script>
    const apiKey = "TP6duc7H0lDuNEKyPrpR49mtr5dJqTNwYw8vjgKZ";

    // Estimated conversion to grams for common volume units
    const unitToGrams = {
      tbsp: 15,
      teaspoon: 5,
      tsp: 5,
      cup: 240,
      oz: 28.35,
      ml: 1,
      g: 1,
      gram: 1,
      grams: 1,
      kg: 1000
    };

    function parseQuantity(input) {
      const regex = /^([\d.\/]+)\s*(tbsp|tsp|teaspoon|cup|oz|ml|g|gram|grams|kg)?\s*(.+)$/i;
      const match = input.trim().match(regex);

      if (!match) return null;

      let [_, qtyStr, unit, food] = match;
      let quantity = eval(qtyStr.replace(" ", "+")); // handles "1 1/2"

      unit = unit ? unit.toLowerCase() : "g";
      const grams = unitToGrams[unit] || 1;
      return {
        quantity,
        unit,
        gramsEquivalent: quantity * grams,
        foodName: food.trim()
      };
    }

    async function analyzeFood() {
      const input = document.getElementById("foodInput").value.trim();
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "Loading...";

      const parsed = parseQuantity(input);
      if (!parsed) {
        resultsDiv.innerHTML = "<p>Please use a format like '2 tbsp peanut butter' or '150g chicken breast'.</p>";
        return;
      }

      try {
        const searchURL = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(parsed.foodName)}&pageSize=1&api_key=${apiKey}`;
        const response = await fetch(searchURL);
        const data = await response.json();

        if (!data.foods || data.foods.length === 0) {
          resultsDiv.innerHTML = "<p>No food item found. Try something more specific.</p>";
          return;
        }

        const food = data.foods[0];
        const nutrients = food.foodNutrients;

        let sodium = 0, potassium = 0, protein = 0, phosphorus = 0;

        nutrients.forEach(n => {
          switch (n.nutrientName.toLowerCase()) {
            case "sodium, na": sodium = n.value; break;
            case "potassium, k": potassium = n.value; break;
            case "protein": protein = n.value; break;
            case "phosphorus, p": phosphorus = n.value; break;
          }
        });

        // USDA values are typically per 100g — scale to user grams
        const scale = parsed.gramsEquivalent / 100;

        const scaledSodium = sodium * scale;
        const scaledPotassium = potassium * scale;
        const scaledProtein = protein * scale;
        const scaledPhosphorus = phosphorus * scale;

        let alerts = [];
        if (scaledSodium > 2000) alerts.push("Sodium exceeds 2,000mg/day");
        if (scaledPotassium > 4000) alerts.push("Potassium exceeds 4,000mg/day");
        if (scaledProtein > 51) alerts.push("Protein exceeds 51g/day");
        if (scaledPhosphorus > 1000) alerts.push("Phosphorus exceeds 1,000mg/day");

        resultsDiv.innerHTML = `
          <h3>Result for: ${parsed.quantity} ${parsed.unit} ${parsed.foodName}</h3>
          <ul>
            <li><strong>Sodium:</strong> ${scaledSodium.toFixed(1)} mg</li>
            <li><strong>Potassium:</strong> ${scaledPotassium.toFixed(1)} mg</li>
            <li><strong>Protein:</strong> ${scaledProtein.toFixed(1)} g</li>
            <li><strong>Phosphorus:</strong> ${scaledPhosphorus.toFixed(1)} mg</li>
          </ul>
          ${alerts.length ? `<p class="alert">⚠️ ${alerts.join("; ")}</p>` : "<p>No alerts. Nutrients within suggested range.</p>"}
        `;
      } catch (error) {
        resultsDiv.innerHTML = "<p>Something went wrong. Please try again.</p>";
        console.error(error);
      }
    }
  </script>
</body>
</html>
