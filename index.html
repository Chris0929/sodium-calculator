<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nutrition & Sodium Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    textarea, input { width: 100%; margin: 10px 0; padding: 10px; font-size: 1rem; }
    button { padding: 10px 20px; font-size: 1rem; cursor: pointer; }
    .nutrient-table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    .nutrient-table th, .nutrient-table td { border: 1px solid #ddd; padding: 8px; }
    .nutrient-table th { background-color: #f2f2f2; }
    .loader { margin-top: 20px; font-weight: bold; color: #007BFF; }
    canvas { max-width: 100%; margin-top: 30px; }
  </style>
</head>
<body>

<h2>Nutrition & Sodium Calculator</h2>
<p>Paste your recipe below (e.g., "2 cups flour, 1 tsp salt, 1 tbsp olive oil"):</p>

<textarea id="recipeInput" rows="8" placeholder="Enter your ingredients line by line..."></textarea>

<label>Number of Servings:</label>
<input type="number" id="servings" value="1" min="1" />

<button onclick="analyzeRecipe()">Analyze Recipe</button>

<div class="loader" id="loader" style="display:none;">Analyzing... Please wait.</div>
<div id="results"></div>
<canvas id="macroChart"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const apiKey = "TP6duc7H0lDuNEKyPrpR49mtr5dJqTNwYw8vjgKZ";

async function getNutrientData(ingredientLine) {
  // Remove quantities and units to isolate ingredient name
  // Basic pattern: remove leading numbers, fractions, and common units
  let cleaned = ingredientLine.toLowerCase();
  cleaned = cleaned.replace(/^\s*[\d\/\.\s-]+/, ''); // remove leading numbers/fractions
  cleaned = cleaned.replace(/\b(tsp|tbsp|tablespoon|teaspoon|cup|grams|g|kg|ml|l|ounce|oz|pound|lb)s?\b/g, '');
  cleaned = cleaned.replace(/[,\.\(\)]/g, ''); // remove commas, dots, parentheses
  cleaned = cleaned.trim();

  if (cleaned.length === 0) return null;

  const encodedQuery = encodeURIComponent(cleaned);
  const url = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodedQuery}&pageSize=1&api_key=${API_KEY}`;

  const response = await fetch(url);
  if (!response.ok) return null;

  const data = await response.json();

  if (!data.foods || data.foods.length === 0) {
    console.log(`No results for query: "${cleaned}"`);
    return null;
  }

  return data.foods[0];
}

  let html = "<h3>Nutrition Facts (per total recipe)</h3>";
  html += "<table class='nutrient-table'><tr><th>Nutrient</th><th>Amount</th></tr>";
  for (let nutrient in totalNutrients) {
    const total = totalNutrients[nutrient];
    const perServing = total.value / servings;
    html += `<tr><td>${nutrient}</td><td>${perServing.toFixed(2)} ${total.unit}</td></tr>`;
  }
  html += "</table>";

  const sodium = totalNutrients["Sodium, Na"]?.value || 0;
  if (sodium / servings > 1500) {
    html += "<p style='color:red; font-weight: bold;'>⚠️ High Sodium Detected. Consider low-sodium alternatives like unsalted butter or reduced-sodium broth.</p>";
  }

  results.innerHTML = html;

  // Draw Macro Chart
  const macros = ["Protein", "Total lipid (fat)", "Carbohydrate, by difference"];
  const values = macros.map(m => totalNutrients[m]?.value / servings || 0);
  const ctx = document.getElementById('macroChart').getContext('2d');
  document.getElementById('macroChart').style.display = 'block';
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: macros,
      datasets: [{
        data: values,
        backgroundColor: ['#4caf50', '#2196f3', '#ff9800']
      }]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: 'Macronutrient Distribution (per serving)'
        }
      }
    }
  });

  // Save recipe to localStorage
  const history = JSON.parse(localStorage.getItem("recipeHistory") || "[]");
  history.unshift({ text: input.join(', '), timestamp: Date.now() });
  localStorage.setItem("recipeHistory", JSON.stringify(history.slice(0, 5)));
}
</script>

</body>
</html>
