<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CKD Nutrient Analyzer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f3f0;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 2em;
    }
    h1 {
      color: #b9848c;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 1em;
    }
    button {
      background-color: #ffd1dc;
      color: #333;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .results {
      margin-top: 2em;
      padding: 1em;
      background: #fffaf5;
      border-radius: 8px;
      box-shadow: 0 0 10px #eee;
    }
    .alert {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>CKD Nutrient Analyzer</h1>
  <p><strong>Stage 3 CKD Guidelines:</strong><br>
  Sodium: ~2000mg/day<br>
  Protein: 47–51g/day<br>
  Calories: 2116–2962/day<br>
  Potassium: 2000–4000mg/day<br>
  Phosphorus: 800–1000mg/day</p>

  <p>Enter food and amount (e.g., <em>"1 cup spinach, 2 tbsp peanut butter"</em>):</p>
  <textarea id="foodInput" placeholder="e.g., 1 cup spinach, 2 tbsp peanut butter"></textarea>
  <button onclick="analyzeFood()">Analyze</button>

  <div id="results" class="results"></div>

  <script>
    const API_KEY = "TP6duc7H0lDuNEKyPrpR49mtr5dJqTNwYw8vjgKZ";

    async function analyzeFood() {
      const input = document.getElementById("foodInput").value;
      const foodList = input.split(",");
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "<p>Analyzing...</p>";

      let total = {
        sodium: 0,
        potassium: 0,
        protein: 0,
        phosphorus: 0
      };

      for (const itemRaw of foodList) {
        const item = itemRaw.trim();
        if (!item) continue;

        const searchUrl = `https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${API_KEY}&query=${encodeURIComponent(item)}&dataType=Foundation,SR%20Legacy&pageSize=1`;
        const searchResponse = await fetch(searchUrl);
        const searchData = await searchResponse.json();

        if (!searchData.foods || searchData.foods.length === 0) continue;

        const food = searchData.foods[0];
        const foodId = food.fdcId;

        const detailUrl = `https://api.nal.usda.gov/fdc/v1/food/${foodId}?api_key=${API_KEY}`;
        const detailResponse = await fetch(detailUrl);
        const detailData = await detailResponse.json();

        let multiplier = 1;
        const match = item.match(/(\d+(\.\d+)?)\s?(cup|tbsp|tsp|g|oz|ml)/i);
        if (match) {
          const qty = parseFloat(match[1]);
          const unit = match[3].toLowerCase();

          const unitToGram = {
            g: 1,
            oz: 28.35,
            ml: 1,
            tsp: 4.2,
            tbsp: 14.3,
            cup: 240
          };

          multiplier = (qty * (unitToGram[unit] || 100)) / 100; // Base 100g scaling
        }

        detailData.foodNutrients.forEach(n => {
          const name = n.nutrient.name.toLowerCase();
          const amount = n.amount * multiplier;

          if (name.includes("sodium")) total.sodium += amount;
          if (name.includes("potassium")) total.potassium += amount;
          if (name.includes("protein")) total.protein += amount;
          if (name.includes("phosphorus")) total.phosphorus += amount;
        });
      }

      let output = `<h3>Total Nutrients:</h3>
        <p>Sodium: ${total.sodium.toFixed(1)} mg ${total.sodium > 2000 ? '<span class="alert">(Limit exceeded!)</span>' : ''}</p>
        <p>Potassium: ${total.potassium.toFixed(1)} mg ${total.potassium > 4000 ? '<span class="alert">(Limit exceeded!)</span>' : ''}</p>
        <p>Protein: ${total.protein.toFixed(1)} g ${total.protein > 51 ? '<span class="alert">(Limit exceeded!)</span>' : ''}</p>
        <p>Phosphorus: ${total.phosphorus.toFixed(1)} mg ${total.phosphorus > 1000 ? '<span class="alert">(Limit exceeded!)</span>' : ''}</p>`;

      resultsDiv.innerHTML = output;
    }
  </script>
</body>
</html>
