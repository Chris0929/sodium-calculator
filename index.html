<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nutrition Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background-color: #fff8f0;
      color: #333;
    }
    label, textarea, input {
      display: block;
      margin-bottom: 1rem;
    }
    textarea {
      width: 100%;
      padding: 0.5rem;
      font-family: monospace;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #ffeedd;
    }
    button {
      background-color: #ffb347;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    button:hover {
      background-color: #ff9933;
    }
  </style>
</head>
<body>

<h1>Nutrition Calculator</h1>

<label for="ingredients">Enter Ingredients (one per line as grams + tab + food name):</label>
<textarea id="ingredients" rows="10">100	Chicken breast, cooked
200	White rice, cooked
50	Broccoli, raw</textarea>

<label for="servings">Number of Servings:</label>
<input type="number" id="servings" value="2" min="1"/>

<button id="calculate">Calculate</button>

<div id="results"></div>

<script>
const apiKey = "TP6duc7H0lDuNEKyPrpR49mtr5dJqTNwYw8vjgKZ";
const nutrientKeys = {
  208: "calories",
  203: "protein",
  204: "fat",
  205: "carbs",
  269: "sugar",
  307: "sodium",
  306: "potassium",
  305: "phosphorus",
  303: "iron",
  301: "calcium",
  304: "magnesium"
};

function parseIngredients(input) {
  return input.split("\n").map(line => {
    const [gramsStr, ...foodArr] = line.trim().split("\t");
    return {
      grams: parseFloat(gramsStr),
      food: foodArr.join(" ").trim()
    };
  }).filter(i => i.grams && i.food);
}

async function fetchNutrientData(ingredient) {
  const searchRes = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(ingredient.food)}&api_key=${apiKey}`);
  const searchData = await searchRes.json();
  const firstMatch = searchData.foods?.[0];
  if (!firstMatch) return null;

  const detailRes = await fetch(`https://api.nal.usda.gov/fdc/v1/food/${firstMatch.fdcId}?api_key=${apiKey}`);
  const detailData = await detailRes.json();

  const nutrientData = {};
  detailData.foodNutrients.forEach(n => {
    const key = nutrientKeys[n.nutrientNumber];
    if (key) {
      nutrientData[key] = n.amount;
    }
  });

  return {
    name: ingredient.food,
    grams: ingredient.grams,
    nutrients: nutrientData
  };
}

function scaleNutrients(nutrients, scale) {
  const result = {};
  for (const key in nutrientKeys) {
    const k = nutrientKeys[key];
    result[k] = (nutrients[k] || 0) * scale;
  }
  return result;
}

function sumNutrients(total, toAdd) {
  for (const key in toAdd) {
    total[key] = (total[key] || 0) + toAdd[key];
  }
  return total;
}

document.getElementById("calculate").addEventListener("click", async () => {
  const ingredientsInput = document.getElementById("ingredients").value;
  const servings = parseFloat(document.getElementById("servings").value);
  const ingredients = parseIngredients(ingredientsInput);

  const totalNutrients = {};
  const promises = ingredients.map(async ing => {
    const data = await fetchNutrientData(ing);
    if (data) {
      const scale = data.grams / 100;
      const scaled = scaleNutrients(data.nutrients, scale);
      sumNutrients(totalNutrients, scaled);
    }
  });

  await Promise.all(promises);

  const perServing = {};
  for (const key in totalNutrients) {
    perServing[key] = (totalNutrients[key] / servings).toFixed(2);
  }

  const results = `
    <h2>Nutrition per Serving</h2>
    <table>
      <tr><th>Nutrient</th><th>Amount</th></tr>
      <tr><td>Calories</td><td>${perServing.calories} kcal</td></tr>
      <tr><td>Protein</td><td>${perServing.protein} g</td></tr>
      <tr><td>Fat</td><td>${perServing.fat} g</td></tr>
      <tr><td>Carbohydrates</td><td>${perServing.carbs} g</td></tr>
      <tr><td>Sugar</td><td>${perServing.sugar} g</td></tr>
      <tr><td>Sodium</td><td>${perServing.sodium} mg</td></tr>
      <tr><td>Potassium</td><td>${perServing.potassium} mg</td></tr>
      <tr><td>Phosphorus</td><td>${perServing.phosphorus} mg</td></tr>
      <tr><td>Iron</td><td>${perServing.iron} mg</td></tr>
      <tr><td>Calcium</td><td>${perServing.calcium} mg</td></tr>
      <tr><td>Magnesium</td><td>${perServing.magnesium} mg</td></tr>
    </table>
  `;

  document.getElementById("results").innerHTML = results;
});
</script>

</body>
</html>
